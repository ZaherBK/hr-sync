{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <!-- En-tête de la page -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Détails du Prêt #{{ loan.id }}</h2>
        <a href="{{ url_for('loans_page') }}" class="btn btn-outline-secondary">
            &larr; Retour à la liste
        </a>
    </div>

    <div class="row">
        <!-- Colonne de Gauche: Infos + Formulaire -->
        <div class="col-lg-5">
            
            <!-- Carte 1: Informations sur le Prêt -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-body-tertiary">
                    <h5 class="mb-0">Informations sur le Prêt</h5>
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ loan.employee.first_name }} {{ loan.employee.last_name }}</h5>
                    <p class="card-text"><strong>Montant Principal:</strong> {{ "%.2f"|format(loan.principal) }} TND</p>
                    <p class="card-text">
                        <strong>Statut:</strong>
                        <!-- Couleurs améliorées -->
                        <span class="badge fs-6
                            {% if loan.status.value == 'draft' %}text-bg-secondary
                            {% elif loan.status.value == 'active' %}text-bg-success
                            {% elif loan.status.value == 'paid' %}text-bg-info
                            {% else %}text-bg-primary{% endif %}">
                            {{ loan.status.value | title }}
                        </span>
                    </p>
                    <p class="card-text"><strong>Date de début:</strong> {{ loan.start_date }}</p>
                    <p class="card-text"><strong>Termes:</strong> {{ loan.term_count }} {{ loan.term_unit.value }}(s)</p>
                    <hr>
                    
                    <div class="fw-bold">
                        <p class="card-text">Total à Payer: <span class="float-end">{{ "%.2f"|format(loan.scheduled_total) }} TND</span></p>
                        <p class="card-text">Total Remboursé: <span class="float-end text-success">{{ "%.2f"|format(loan.repaid_total) }} TND</span></p>
                        <hr>
                        <p class="card-text fs-5">Solde Restant: <span class="float-end text-danger">{{ "%.2f"|format(loan.scheduled_total - loan.repaid_total) }} TND</span></p>
                    </div>
                </div>
            </div>

            <!-- Carte 2: Effectuer un Remboursement -->
            {% if loan.status.value == 'active' %}
            <div class="card shadow-sm">
                <div class="card-header bg-body-tertiary">
                    <h5 class="mb-0">Effectuer un Remboursement</h5>
                </div>
                <div class="card-body">
                    <!-- Note : La logique de remboursement flexible (50 au lieu de 100) est déjà gérée par l'API ! -->
                    <!-- Vous n'avez pas besoin de changer le script, juste de soumettre le montant que vous voulez. -->
                    <form action="{{ url_for('loan_repay_web', loan_id=loan.id) }}" method="POST">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Montant</label>
                            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="paid_on" class="form-label">Payé le</label>
                            <input type="date" class="form-control" id="paid_on" name="paid_on" value="{{ today_date }}" required>
                        </div>
                         <div class="mb-3">
                            <label for="notes" class="form-label">Notes (Optionnel)</label>
                            <input type="text" class="form-control" id="notes" name="notes">
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-save"></i> Enregistrer le paiement
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- Colonne de Droite: Échéancier -->
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-body-tertiary">
                    <h5 class="mb-0">Échéancier de Remboursement</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date d'échéance</th>
                                    <th>Montant Dû</th>
                                    <th>Montant Payé</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in loan.schedules %}
                                <tr>
                                    <td>{{ s.sequence_no }}</td>
                                    <td>{{ s.due_date }}</td>
                                    <td>{{ "%.2f"|format(s.due_total) }}</td>
                                    <td class="text-success">{{ "%.2f"|format(s.paid_total) }}</td>
                                    <td>
                                        <!-- Couleurs améliorées -->
                                        <span class="badge 
                                            {% if s.status.value == 'paid' %}text-bg-success
                                            {% elif s.status.value == 'pending' %}text-bg-secondary
                                            {% elif s.status.value == 'partial' %}text-bg-warning
                                            {% elif s.status.value == 'overdue' %}text-bg-danger
                                            {% else %}text-bg-light{% endif %}">
                                            {{ s.status.value | title }}
                                        </span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">Aucun échéancier trouvé.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Historique des transactions -->
            {% if loan.repayments %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-body-tertiary">
                    <h5 class="mb-0">Historique des Transactions</h5>
                </div>
                <div class="card-body">
                     <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                             <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Montant</th>
                                    <th>Source</th>
                                </tr>
                             </thead>
                             <tbody>
                                {% for r in loan.repayments %}
                                <tr>
                                    <td>{{ r.paid_on }}</td>
                                    <td class="text-success">{{ "%.2f"|format(r.amount) }} TND</td>
                                    <td><span class="badge text-bg-light">{{ r.source.value }}</span></td>
                                </tr>
                                {% endfor %}
                             </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>
    </div>

</div>
{% endblock %}
