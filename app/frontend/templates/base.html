<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ app_name }}{% endblock %}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}">
    <link rel="icon" href="{{ url_for('static', path='/logo.png') }}" type="image/png">
</head>
<body>

    <div class="d-flex">
        <!-- Sidebar -->
        <nav class="sidebar bg-body-tertiary shadow-sm">
            <div class="sidebar-header d-flex align-items-center justify-content-center p-3">
                <img src="{{ url_for('static', path='/logo.png') }}" alt="Logo" style="width: 40px; height: 40px; border-radius: 50%;">
                <h5 class="ms-2 mb-0 d-none d-md-inline">{{ app_name }}</h5>
            </div>
            
            <ul class="nav nav-pills flex-column p-2">
                <li class="nav-item">
                    <a href="{{ url_for('home') }}" class="nav-link {% if request.url.path == '/' %}active{% endif %}">
                        <i class="fa-solid fa-house me-2"></i><span class="d-none d-md-inline">Accueil</span>
                    </a>
                </li>
                
                {% if user.permissions.can_manage_employees %}
                <li class="nav-item">
                    <a href="{{ url_for('employees_page') }}" class="nav-link {% if 'employees' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-users me-2"></i><span class="d-none d-md-inline">Employés</span>
                    </a>
                </li>
                {% endif %}

                {% if user.permissions.can_manage_absences %}
                <li class="nav-item">
                    <a href="{{ url_for('attendance_page') }}" class="nav-link {% if 'attendance' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-user-clock me-2"></i><span class="d-none d-md-inline">Absences</span>
                    </a>
                </li>
                {% endif %}

                {% if user.permissions.can_manage_deposits %}
                <li class="nav-item">
                    <a href="{{ url_for('deposits_page') }}" class="nav-link {% if 'deposits' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-hand-holding-dollar me-2"></i><span class="d-none d-md-inline">Avances</span>
                    </a>
                </li>
                {% endif %}

                {% if user.permissions.can_manage_leaves %}
                <li class="nav-item">
                    <a href="{{ url_for('leaves_page') }}" class="nav-link {% if 'leaves' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-person-walking-luggage me-2"></i><span class="d-none d-md-inline">Congés</span>
                    </a>
                </li>
                {% endif %}

                <!-- NOUVEAU : Bouton Prêts -->
                {% if user.permissions.can_manage_loans %}
                <li class="nav-item">
                    <a href="{{ url_for('loans_page') }}" class="nav-link {% if 'loan' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-money-bill-transfer me-2"></i><span class="d-none d-md-inline">Prêts</span>
                    </a>
                </li>
                {% endif %}
                <!-- FIN NOUVEAU -->

                {% if user.permissions.can_manage_pay %}
                <li class="nav-item">
                    <a href="{{ url_for('pay_employee_page') }}" class="nav-link {% if 'pay' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-file-invoice-dollar me-2"></i><span class="d-none d-md-inline">Paiement</span>
                    </a>
                </li>
                {% endif %}

                {% if user.permissions.can_view_reports %}
                <li class="nav-item">
                    <a href="{{ url_for('employee_report_index') }}" class="nav-link {% if 'report' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-chart-line me-2"></i><span class="d-none d-md-inline">Rapports</span>
                    </a>
                </li>
                {% endif %}

                <!-- Routes Admin -->
                {% if user.permissions.is_admin %}
                <li class="nav-item mt-3 pt-3 border-top">
                    <span class="nav-link-title d-none d-md-inline text-muted small">Admin</span>
                </li>
                {% if user.permissions.can_manage_users %}
                <li class="nav-item">
                    <a href="{{ url_for('users_page') }}" class="nav-link {% if 'users' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-user-shield me-2"></i><span class="d-none d-md-inline">Utilisateurs</span>
                    </a>
                </li>
                {% endif %}
                {% if user.permissions.can_manage_roles %}
                <li class="nav-item">
                    <a href="{{ url_for('roles_page') }}" class="nav-link {% if 'roles' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-key me-2"></i><span class="d-none d-md-inline">Rôles & Perms</span>
                    </a>
                </li>
                {% endif %}
                {% if user.permissions.can_view_settings %}
                 <li class="nav-item">
                    <a href="{{ url_for('settings_page') }}" class="nav-link {% if 'settings' in request.url.path %}active{% endif %}">
                        <i class="fa-solid fa-gears me-2"></i><span class="d-none d-md-inline">Paramètres</span>
                    </a>
                </li>
                {% endif %}
                {% endif %}
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="main-content flex-grow-1">
            <!-- Top Navbar -->
            <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm sticky-top">
                <div class="container-fluid">
                    <!-- Bouton pour ouvrir/fermer le sidebar sur mobile -->
                    <button class="btn btn-light d-md-none me-2" type="button" id="sidebarToggle">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    
                    <span class="navbar-brand mb-0 h1 d-md-none">{{ app_name }}</span>

                    <div class="ms-auto d-flex align-items-center">
                        <!-- Sélecteur de Thème -->
                        <div class="dropdown me-3">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa-solid fa-sun" id="theme-icon"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
                                <li><a class="dropdown-item" href="#" data-theme="light"><i class="fa-solid fa-sun me-2"></i> Clair</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="dark"><i class="fa-solid fa-moon me-2"></i> Sombre</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="auto"><i class="fa-solid fa-circle-half-stroke me-2"></i> Auto</a></li>
                            </ul>
                        </div>
                        
                        <!-- Profil Utilisateur -->
                        <div class="dropdown">
                            <a href="#" class="d-block link-body-emphasis text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa-solid fa-user-circle fs-3"></i>
                                <span class="d-none d-md-inline ms-1">{{ user.full_name }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end text-small" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="fa-solid fa-right-from-bracket me-2"></i>Déconnexion</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Contenu de la Page -->
            <main class="container-fluid p-4">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <!-- Script pour le Thème -->
    <script>
        const getPreferredTheme = () => {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                return storedTheme;
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        const setTheme = (theme) => {
            const themeIcon = document.getElementById('theme-icon');
            if (theme === 'auto') {
                document.documentElement.setAttribute('data-bs-theme', (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
                if (themeIcon) themeIcon.className = 'fa-solid fa-circle-half-stroke';
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme);
                if (themeIcon) {
                    if (theme === 'light') {
                        themeIcon.className = 'fa-solid fa-sun';
                    } else {
                        themeIcon.className = 'fa-solid fa-moon';
                    }
                }
            }
        };

        setTheme(getPreferredTheme());

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme !== 'light' && storedTheme !== 'dark') {
                setTheme(getPreferredTheme());
            }
        });

        document.querySelectorAll('[data-theme]').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const theme = button.getAttribute('data-theme');
                localStorage.setItem('theme', theme);
                setTheme(theme);
            });
        });
        
        // Toggle sidebar mobile
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        if(sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
        }

    </script>
</body>
</html>
