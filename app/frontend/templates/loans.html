{% extends "base.html" %}
{% block content %}
<h2 class="page-title"><i class="fa-solid fa-hand-holding-dollar"></i> Prêts</h2>

<div class="card form-card">
  <!-- FIX: Retrait de la classe 'form-grid' pour que les 'form-group' s'empilent verticalement -->
  <form method="post" action="{{ url_for('loans_create_web') }}">
    <div class="form-row">
      <div class="form-group full-width">
        <label>Employé</label>
        <select name="employee_id" class="form-select" required>
          {% for e in employees %}<option value="{{e.id}}">{{e.first_name}} {{e.last_name}}</option>{% endfor %}
        </select>
      </div>
        <div class="form-group"><label>Montant (Crédit)</label><input type="number" step="0.01" name="principal" class="form-control" required></div>
        <div class="form-group"><label>Nbr. de Termes</label><input type="number" name="term_count" class="form-control" value="1" required></div>
        <div class="form-group"><label>Fréquence</label>
        <select name="term_unit" class="form-select"><option value="month">Mensuel</option><option value="week">Hebdo</option></select>
      </div>
        <div class="form-group"><label>Date de Début</label><input type="date" name="start_date" class="form-control" required></div>
      <div class="form-group full-width"><label>1ère Échéance (Facultatif)</label><input type="date" name="first_due_date" class="form-control"></div>
    </div>
    
    <div class="form-actions" style="margin-top: 1rem;"><button class="btn btn-primary">Créer Crédit</button></div>
  </form>
</div>

<div class="card table-card">
  <div class="table-responsive">
    <table>
      <thead><tr><th>#</th><th>Employé</th><th>Montant</th><th>Statut</th><th>Prochain Échéance</th><th>Actions</th></tr></thead>
      <tbody>
        {% for l in loans %}
        <tr>
          <td>{{ l.id }}</td>
          <td class="details">{{ l.employee.first_name }} {{ l.employee.last_name }}</td>
          <td class="amount">{{ '%.2f'|format(l.principal) }} TND</td>
          <td>
            <span class="badge 
              {% if l.status == 'active' %}action-create
              {% elif l.status == 'paid' %}action-approve
              {% else %}status-inactive{% endif %}">
              {{ l.status }}
            </span>
          </td>
          <td class="timestamp">{{ l.next_due_on or '-' }}</td>
          <td><a class="btn btn-secondary" href="{{ url_for('loan_detail_page', loan_id=l.id) }}">Détails</a></td>
        </tr>
        {% else %}<tr><td colspan="6" class="no-data">Aucun prêt.</td></tr>{% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
