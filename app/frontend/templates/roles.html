{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="page-title"><i class="fa-solid fa-shield-halved"></i> Gestion des Rôles</h2>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRoleModal">
    <i class="fa-solid fa-plus"></i> Créer un Rôle
  </button>
</div>

<p class="hint">
  Créez de nouveaux rôles (ex: "High Manager", "Comptable") et assignez-leur des permissions granulaires.
  L'Admin a un accès "God Mode" permanent.
</p>

<div class="card table-card">
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Nom du Rôle</th>
          <th>Permissions Spéciales</th>
          <th style="width: 150px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for role in roles %}
        <tr>
          <td class="details"><strong>{{ role.name }}</strong></td>
          <td>
            {% if role.is_admin %}
              <span class="badge" style="background:rgba(239,68,68,.26); color:#ffd0d0;">Admin (God Mode)</span>
            {% endif %}
            {% if role.can_manage_users %}
              <span class="badge" style="background:rgba(245,158,11,.22); color:#ffe0a8;">Gère Utilisateurs</span>
            {% endif %}
            {% if role.can_view_settings %}
              <span class="badge" style="background:rgba(56,189,248,.2); color:#c9ecff;">Voit Paramètres</span>
            {% endif %}
          </td>
          <td>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editRoleModal-{{ role.id }}">
              <i class="fa-solid fa-edit"></i>
            </button>
            {% if not role.is_admin and role.users|length == 0 %}
            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteRoleModal-{{ role.id }}">
              <i class="fa-solid fa-trash"></i>
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="createRoleModal" tabindex="-1" aria-labelledby="createRoleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content card">
      <form action="{{ url_for('roles_create') }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="createRoleModalLabel">Créer un Nouveau Rôle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
        </div>
        <div class="modal-body">
          <div class_form-group full-width">
            <div class="form-group">
              <label for="name">Nom du Rôle</label>
              <input type="text" name="name" class="form-control" required placeholder="ex: High Manager">
            </div>
          </div>
        </div>
        <div class="modal-footer form-actions">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Créer et Modifier les Permissions</button>
        </div>
      </form>
    </div>
  </div>
</div>


{% for role in roles %}
  <div class="modal fade" id="editRoleModal-{{ role.id }}" tabindex="-1" aria-labelledby="editRoleModalLabel-{{ role.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content card">
        <form action="{{ url_for('roles_update', role_id=role.id) }}" method="post">
          <div class="modal-header">
            <h5 class="modal-title" id="editRoleModalLabel-{{ role.id }}">Modifier les permissions pour : <strong>{{ role.name }}</strong></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
          </div>
          <div class="modal-body">
            
            {% if role.is_admin %}
            <div class="alert alert-danger">
              <i class="fa-solid fa-gavel"></i> <strong>Mode Dieu (God Mode)</strong><br>
              Ce rôle est un super-administrateur. Il a toutes les permissions, quoi qu'il arrive.
              Vous ne pouvez pas modifier ces permissions.
            </div>
            {% else %}
            
            <div class="row">
              <div class="col-md-6">
                <h5><i class="fa-solid fa-cogs"></i> Système</h5>
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_manage_users" id="can_manage_users-{{ role.id }}" value="true" {% if role.can_manage_users %}checked{% endif %}>
                  <label class="form-check-label" for="can_manage_users-{{ role.id }}">
                    Gérer les Utilisateurs
                  </label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_manage_roles" id="can_manage_roles-{{ role.id }}" value="true" {% if role.can_manage_roles %}checked{% endif %}>
                  <label class="form-check-label" for="can_manage_roles-{{ role.id }}">
                    Gérer les Rôles
                  </label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_manage_branches" id="can_manage_branches-{{ role.id }}" value="true" {% if role.can_manage_branches %}checked{% endif %}>
                  <label class="form-check-label" for="can_manage_branches-{{ role.id }}">
                    Gérer les Magasins
                  </label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_view_settings" id="can_view_settings-{{ role.id }}" value="true" {% if role.can_view_settings %}checked{% endif %}>
                  <label class="form-check-label" for="can_view_settings-{{ role.id }}">
                    Accéder aux Paramètres
                  </label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_clear_logs" id="can_clear_logs-{{ role.id }}" value="true" {% if role.can_clear_logs %}checked{% endif %}>
                  <label class="form-check-label" for="can_clear_logs-{{ role.id }}">
                    Purger les Données
                  </label>
                </div>
              </div>
              
              <div class="col-md-6">
                <h5><i class="fa-solid fa-users"></i> Gestion Quotidienne</h5>
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_manage_employees" id="can_manage_employees-{{ role.id }}" value="true" {% if role.can_manage_employees %}checked{% endif %}>
                  <label class="form-check-label" for="can_manage_employees-{{ role.id }}">
                    Gérer les Employés
                  </label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_view_reports" id="can_view_reports-{{ role.id }}" value="true" {% if role.can_view_reports %}checked{% endif %}>
                  <label class="form-check-label" for="can_view_reports-{{ role.id }}">
                    Voir les Rapports
                  </label>
                </div>
                 <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_manage_pay" id="can_manage_pay-{{ role.id }}" value="true" {% if role.can_manage_pay %}checked{% endif %}>
                  <label class="form-check-label" for="can_manage_pay-{{ role.id }}">
                    Gérer les Paiements
                  </label>
                </div>
                 <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_manage_absences" id="can_manage_absences-{{ role.id }}" value="true" {% if role.can_manage_absences %}checked{% endif %}>
                  <label class="form-check-label" for="can_manage_absences-{{ role.id }}">
                    Gérer les Absences
                  </label>
                </div>
                 <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_manage_leaves" id="can_manage_leaves-{{ role.id }}" value="true" {% if role.can_manage_leaves %}checked{% endif %}>
                  <label class="form-check-label" for="can_manage_leaves-{{ role.id }}">
                    Gérer les Congés
                  </label>
                </div>
                 <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" name="can_manage_deposits" id="can_manage_deposits-{{ role.id }}" value="true" {% if role.can_manage_deposits %}checked{% endif %}>
                  <label class="form-check-label" for="can_manage_deposits-{{ role.id }}">
                    Gérer les Avances
                  </label>
                </div>
              </div>
            </div>
            
            {% endif %}
            
          </div>
          <div class="modal-footer form-actions">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            {% if not role.is_admin %}
            <button type="submit" class="btn btn-primary">Enregistrer les Permissions</button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="deleteRoleModal-{{ role.id }}" tabindex="-1" aria-labelledby="deleteRoleModalLabel-{{ role.id }}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content card">
        <form action="{{ url_for('roles_delete', role_id=role.id) }}" method="post">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteRoleModalLabel-{{ role.id }}">Confirmer la Suppression</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: white;"></button>
          </div>
          <div class="modal-body">
            <p>Êtes-vous sûr de vouloir supprimer le rôle <strong>{{ role.name }}</strong> ?</p>
            <p class="text-danger">Cette action est irréversible et échouera si des utilisateurs sont encore assignés à ce rôle.</p>
          </div>
          <div class="modal-footer form-actions">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-danger">Supprimer ce Rôle</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endfor %}

{% endblock %}
